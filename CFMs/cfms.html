<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duct Flow Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Enhanced shadow */
            padding: 2.5rem;
            width: 100%;
            max-width: 28rem; /* Slightly wider */
            border: 1px solid #e2e8f0; /* Subtle border */
        }
        .input-group {
            margin-bottom: 1.25rem; /* More spacing */
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600; /* Semi-bold labels */
            color: #334155; /* Darker text for labels */
        }
        input[type="number"], select {
            width: 100%;
            padding: 0.75rem 1rem; /* Increased padding */
            border: 1px solid #cbd5e1; /* Lighter border */
            border-radius: 0.75rem; /* Rounded input fields */
            font-size: 1rem;
            color: #475569; /* Slightly darker text for inputs */
            background-color: #f8fafc; /* Very light background for inputs */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #6366f1; /* Purple focus border */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Soft focus shadow */
        }
        /* Removed button styling as the button is no longer present */
        .result-box {
            background-color: #e0f2fe; /* Light blue for results */
            border: 1px solid #90cdf4; /* Blue border */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            text-align: center;
            font-size: 1.25rem; /* Larger result font */
            font-weight: 600;
            color: #1e40af; /* Dark blue text */
        }
        .error-message {
            color: #ef4444; /* Red for errors */
            font-size: 0.875rem;
            margin-top: 0.5rem;
            text-align: center;
        }
        /* Removed loading spinner styling as it's no longer used */
        .flex-row {
            display: flex;
            gap: 1rem; /* Spacing between side-by-side inputs */
        }
        .flex-row > div {
            flex: 1; /* Make them take equal width */
        }
    </style>
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Duct Flow Calculator</h1>

        <div class="input-group">
            <label for="ductShape">Duct Shape:</label>
            <select id="ductShape" class="w-full">
                <option value="rectangular">Rectangular</option>
                <option value="circular">Circular</option>
            </select>
        </div>

        <div id="rectangularInputs" class="input-group">
            <div class="flex-row">
                <div>
                    <label for="width">Width:</label>
                    <input type="number" id="width" placeholder="Enter width" step="0.01">
                </div>
                <div>
                    <label for="widthUnit">Unit:</label>
                    <select id="widthUnit">
                        <option value="mm">mm</option>
                        <option value="cm">cm</option>
                        <option value="m">m</option>
                        <option value="in" selected>in</option>
                        <option value="ft">ft</option>
                    </select>
                </div>
            </div>
            <div class="flex-row mt-4">
                <div>
                    <label for="height">Height:</label>
                    <input type="number" id="height" placeholder="Enter height" step="0.01">
                </div>
                <div>
                    <label for="heightUnit">Unit:</label>
                    <select id="heightUnit">
                        <option value="mm">mm</option>
                        <option value="cm">cm</option>
                        <option value="m">m</option>
                        <option value="in" selected>in</option>
                        <option value="ft">ft</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="circularInputs" class="input-group hidden">
            <div class="flex-row">
                <div>
                    <label for="diameter">Diameter:</label>
                    <input type="number" id="diameter" placeholder="Enter diameter" step="0.01">
                </div>
                <div>
                    <label for="diameterUnit">Unit:</label>
                    <select id="diameterUnit">
                        <option value="mm">mm</option>
                        <option value="cm">cm</option>
                        <option value="m">m</option>
                        <option value="in" selected>in</option>
                        <option value="ft">ft</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="input-group">
            <div class="flex-row">
                <div>
                    <label for="pressure">Pressure (Velocity Pressure):</label>
                    <input type="number" id="pressure" placeholder="Enter pressure" step="0.01">
                </div>
                <div>
                    <label for="pressureUnit">Unit:</label>
                    <select id="pressureUnit">
                        <option value="Pa">Pa</option>
                        <option value="psi">psi</option>
                        <option value="inH2O" selected>in. H2O</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Removed the Calculate Flow button -->

        <div id="result" class="result-box hidden">
            Flow Rate: <span id="flowRateValue"></span> <span id="flowRateUnit"></span>
        </div>
        <p id="errorMessage" class="error-message hidden"></p>
    </div>

    <script>
        // Register service worker for PWA capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        // Service Worker registered successfully
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        const ductShapeSelect = document.getElementById('ductShape');
        const rectangularInputs = document.getElementById('rectangularInputs');
        const circularInputs = document.getElementById('circularInputs');
        const resultDiv = document.getElementById('result');
        const flowRateValueSpan = document.getElementById('flowRateValue');
        const flowRateUnitSpan = document.getElementById('flowRateUnit');
        const errorMessageDiv = document.getElementById('errorMessage');

        // Function to toggle duct shape inputs
        function toggleDuctInputs() {
            if (ductShapeSelect.value === 'rectangular') {
                rectangularInputs.classList.remove('hidden');
                circularInputs.classList.add('hidden');
            } else {
                rectangularInputs.classList.add('hidden');
                circularInputs.classList.remove('hidden');
            }
            performCalculationIfReady(); // Trigger calculation when shape changes
        }

        // Event listener for duct shape change
        ductShapeSelect.addEventListener('change', toggleDuctInputs);

        // Initial call to set correct inputs on load
        toggleDuctInputs();

        // Unit conversion constants
        const CONVERSION_FACTORS = {
            length: {
                'mm': 0.001,
                'cm': 0.01,
                'm': 1,
                'in': 0.0254,
                'ft': 0.3048
            },
            pressure: {
                'Pa': 1,
                'psi': 6894.76,
                'inH2O': 249.089
            },
            flow: {
                'm3/s_to_cfm': 2118.88
            }
        };

        // Standard air density (at 20Â°C, 1 atm)
        const AIR_DENSITY = 1.225; // kg/m^3

        /**
         * Converts a value from a given unit to a base SI unit (meters or Pascals).
         * @param {number} value - The numerical value to convert.
         * @param {string} unit - The unit of the value (e.g., 'mm', 'psi').
         * @param {'length' | 'pressure'} type - The type of conversion ('length' or 'pressure').
         * @returns {number} The converted value in SI units.
         */
        function convertToSI(value, unit, type) {
            if (CONVERSION_FACTORS[type] && CONVERSION_FACTORS[type][unit]) {
                return value * CONVERSION_FACTORS[type][unit];
            }
            return value; // Return original value if unit/type not found
        }

        /**
         * Validates input fields.
         * @param {Array<Object>} inputs - An array of objects, each containing an input element and its name.
         * @returns {boolean} True if all inputs are valid, false otherwise.
         */
        function validateInputs(inputs) {
            let isValid = true;
            errorMessageDiv.classList.add('hidden');
            errorMessageDiv.textContent = '';

            for (const inputObj of inputs) {
                const { element, name } = inputObj;
                if (element.value === '' || isNaN(element.value) || parseFloat(element.value) <= 0) {
                    errorMessageDiv.textContent = `Please enter a valid positive number for ${name}.`;
                    errorMessageDiv.classList.remove('hidden');
                    isValid = false;
                    break;
                }
            }
            return isValid;
        }

        /**
         * Triggers the flow calculation if all necessary inputs are filled and valid.
         */
        function performCalculationIfReady() {
            resultDiv.classList.add('hidden'); // Hide previous result
            errorMessageDiv.classList.add('hidden'); // Hide previous error

            let inputsToValidate = [];
            const pressureInput = document.getElementById('pressure');
            inputsToValidate.push({ element: pressureInput, name: 'Pressure' });

            if (ductShapeSelect.value === 'rectangular') {
                const widthInput = document.getElementById('width');
                const heightInput = document.getElementById('height');
                inputsToValidate.push(
                    { element: widthInput, name: 'Width' },
                    { element: heightInput, name: 'Height' }
                );
            } else { // Circular duct
                const diameterInput = document.getElementById('diameter');
                inputsToValidate.push({ element: diameterInput, name: 'Diameter' });
            }

            if (!validateInputs(inputsToValidate)) {
                // If inputs are not valid, just return. Error message is set by validateInputs.
                return;
            }

            // All inputs are valid, proceed with calculation
            try {
                let areaSI; // Area in square meters
                let pressureSI; // Pressure in Pascals

                const pressureUnit = document.getElementById('pressureUnit').value;
                const pressureValue = parseFloat(pressureInput.value);
                pressureSI = convertToSI(pressureValue, pressureUnit, 'pressure');

                if (ductShapeSelect.value === 'rectangular') {
                    const widthInput = document.getElementById('width');
                    const widthUnit = document.getElementById('widthUnit').value;
                    const heightInput = document.getElementById('height');
                    const heightUnit = document.getElementById('heightUnit').value;

                    const widthSI = convertToSI(parseFloat(widthInput.value), widthUnit, 'length');
                    const heightSI = convertToSI(parseFloat(heightInput.value), heightUnit, 'length');
                    areaSI = widthSI * heightSI;
                } else { // Circular duct
                    const diameterInput = document.getElementById('diameter');
                    const diameterUnit = document.getElementById('diameterUnit').value;

                    const diameterSI = convertToSI(parseFloat(diameterInput.value), diameterUnit, 'length');
                    const radiusSI = diameterSI / 2;
                    areaSI = Math.PI * Math.pow(radiusSI, 2);
                }

                // Ensure pressure is non-negative for sqrt
                if (pressureSI < 0) {
                    errorMessageDiv.textContent = 'Pressure cannot be negative for this calculation.';
                    errorMessageDiv.classList.remove('hidden');
                    return;
                }

                // Calculate velocity (v = sqrt(2 * Pv / rho))
                const velocitySI = Math.sqrt((2 * pressureSI) / AIR_DENSITY);

                // Calculate flow rate (Q = A * v)
                const flowRateM3s = areaSI * velocitySI;

                // Convert to CFM for display
                const flowRateCFM = flowRateM3s * CONVERSION_FACTORS.flow['m3/s_to_cfm'];

                flowRateValueSpan.textContent = flowRateCFM.toFixed(2);
                flowRateUnitSpan.textContent = 'CFM';
                resultDiv.classList.remove('hidden');

            } catch (error) {
                console.error('Calculation error:', error);
                errorMessageDiv.textContent = 'An error occurred during calculation. Please check your inputs.';
                errorMessageDiv.classList.remove('hidden');
            }
        }

        // Attach event listeners to all relevant inputs and selects to trigger calculation
        document.getElementById('width').addEventListener('input', performCalculationIfReady);
        document.getElementById('widthUnit').addEventListener('change', performCalculationIfReady);
        document.getElementById('height').addEventListener('input', performCalculationIfReady);
        document.getElementById('heightUnit').addEventListener('change', performCalculationIfReady);
        document.getElementById('diameter').addEventListener('input', performCalculationIfReady);
        document.getElementById('diameterUnit').addEventListener('change', performCalculationIfReady);
        document.getElementById('pressure').addEventListener('input', performCalculationIfReady);
        document.getElementById('pressureUnit').addEventListener('change', performCalculationIfReady);
        // The ductShapeSelect's change listener already calls performCalculationIfReady via toggleDuctInputs
    </script>
</body>
</html>
